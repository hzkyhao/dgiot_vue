<template>
  <div class="instruct">
    <div>
      <el-form :inline="true" :model="formInline" class="demo-form-inline" size="small">
        <el-form-item>
          <el-input v-model="formInline.name" placeholder="请输入指令名称" style="width:500px"></el-input>
        </el-form-item>
        <el-form-item>
          <el-button type="primary" @click="getInstruct(0)">查询</el-button>
        </el-form-item>
      </el-form>
    </div>
    <div class="instruct_button">
      <div>
        <el-button type="primary" size="small" @click="dialogBtn_em('form','3',form)">新增指令</el-button>
        <el-button type="danger" size="small" @click="deleteAll">删 除</el-button>
      </div>
      <div>
        <el-button type="success" size="small">启 用</el-button>
        <el-button type="warning" size="small">禁 用</el-button>
      </div>
    </div>
    <div class="instruct_table">
      <el-table
        ref="multipleTable"
        :data="instructData"
        tooltip-effect="dark"
        style="width: 100%"
        @selection-change="handleSelectionChange"
      >
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column label="指令名称" align="center" sortable width="200">
          <template slot-scope="scope">{{ scope.row.attributes.name }}</template>
        </el-table-column>
        <!-- <el-table-column  label="指令编号" align="center" width="120">
            <template slot-scope="scope">{{ scope.row.attributes.name }}</template>
        </el-table-column>-->
        <el-table-column label="指令类型" align="center" width="100">
          <template slot-scope="scope">
            <el-tag type="primary" v-if=" scope.row.attributes.op=='Read'">读</el-tag>
            <el-tag type="success" v-else>写</el-tag>
          </template>
        </el-table-column>
        <el-table-column label="指令标识" align="center">
          <template slot-scope="scope">{{ scope.row.attributes.di }}</template>
        </el-table-column>
        <el-table-column label="超时时长" align="center" >
          <template slot-scope="scope">{{ scope.row.attributes.duration+'秒'}}</template>
        </el-table-column>
    <!--     <el-table-column label="下发网关" align="center" width="200">
          <template slot-scope="scope">{{ scope.row.attributes.devaddr }}</template>
        </el-table-column> -->
        <el-table-column label="子网编号" align="center" width="200">
          <template slot-scope="scope">{{ scope.row.attributes.pn }}</template>
        </el-table-column>
        <el-table-column label="生效轮次" align="center">
          <template slot-scope="scope">{{ scope.row.attributes.rotation }}</template>
        </el-table-column>

        <el-table-column label="是否启用" align="center" width="100">
          <template slot-scope="scope">
            <el-tag type="success" v-if=" scope.row.attributes.enable">是</el-tag>
            <el-tag type="danger" v-else>否</el-tag>
          </template>
        </el-table-column>
        <el-table-column label="操作" align="center" width="200">
          <template slot-scope="scope">
            <el-button type="primary" size="small" @click="dialogBtn_em('','2',scope.row)">编 辑</el-button>
            <el-button type="danger" size="small" @click="deleteInstruct(scope.row.id)">删 除</el-button>
          </template>
        </el-table-column>
      </el-table>
      <el-pagination
        style="margin-top:20px"
        @size-change="handleSizeChange"
        @current-change="handleCurrentChange"
        :page-sizes="[10, 20, 30, 40]"
        :page-size="pagesize"
        background
        layout="total, sizes, prev, pager, next, jumper"
        :total="total"
      ></el-pagination>
    </div>
    <!--指令弹窗-->
    <el-dialog :title="dialogTitle+'指令'" :visible.sync="dialogFormVisible" @open="openDialog">
      <el-form ref="form" :model="form" size="small" :rules="formrule">
        <p
          style="border: 1px solid rgb(204, 204, 204);
                color: rgb(64, 158, 255);
                font-size: 14px;
                margin-top: 0;
                height: 30px;
                line-height: 30px;
                padding-left: 20px;
                box-sizing: border-box;"
        >指令信息</p>
        <el-row>
          <el-col :span="12">
            <el-form-item label="指令名称" :label-width="formLabelWidth" prop="name">
              <el-input v-model="form.name" autocomplete="off" placeholder="请输入指令名称"></el-input>
            </el-form-item>
            <el-form-item label="操作类型" :label-width="formLabelWidth" prop="type">
              <el-select v-model="form.type" placeholder="请选择操作类型">
                <el-option label="读" value="r"></el-option>
                <el-option label="写" value="w"></el-option>
              </el-select>
            </el-form-item>
            <el-form-item label="是否启用" :label-width="formLabelWidth" prop="enable">
              <el-radio-group v-model="form.enable">
                <el-radio :label="true">是</el-radio>
                <el-radio :label="false">否</el-radio>
              </el-radio-group>
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="指令指标" :label-width="formLabelWidth" prop="pointer">
              <el-input v-model="form.pointer" autocomplete="off" placeholder="请输入指令指标"></el-input>
            </el-form-item>
            <el-form-item label="指令序号" :label-width="formLabelWidth" prop="order">
              <el-input v-model="form.order" autocomplete="off" placeholder="请输入指令序号"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <p
          style="border: 1px solid rgb(204, 204, 204);
                color: rgb(64, 158, 255);
                font-size: 14px;
                margin-top: 0;
                height: 30px;
                line-height: 30px;
                padding-left: 20px;
                box-sizing: border-box;"
        >指令下发策略</p>
        <el-row>
          <el-col :span="12">
   <!--          <el-form-item label="下发网关" :label-width="formLabelWidth" prop="lowerhair">
              <el-input v-model="form.lowerhair" autocomplete="off" placeholder="请输入下发网关"></el-input>
            </el-form-item> -->
            <el-form-item label="超时时长" :label-width="formLabelWidth" prop="duration">
              <el-input v-model.number="form.duration" autocomplete="off" placeholder="请输入超时时长">
                <template slot="append">秒</template>
              </el-input>
            </el-form-item>
            <el-form-item label="生效轮次" :label-width="formLabelWidth" prop="rotation">
              <el-select
                v-model="form.rotation"
                filterable
                clearable
                allow-create
                default-first-option
                placeholder="请选择生效轮次"
              >
                <el-option
                  v-for="item in options"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value"
                ></el-option>
              </el-select>
              <p
                style="color:black;margin:0;position:absolute;top:40px;font-size:12px"
              >例如:1,3,5,8;(可选可自主填写)(注意:逗号为英文逗号)</p>
            </el-form-item>
          </el-col>
          <el-col :span="12 ">
            <el-form-item label="子网编号" :label-width="formLabelWidth" prop="subnet">
              <el-input v-model="form.subnet" autocomplete="off" placeholder="请输入子网编号"></el-input>
            </el-form-item>
            <el-form-item label="发送间隔" :label-width="formLabelWidth" prop="interval">
              <el-input v-model.number="form.interval" autocomplete="off" placeholder="请输入发送间隔">
                <template slot="append">秒</template>
              </el-input>
            </el-form-item>
          </el-col>
        </el-row>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogFormVisible = false">取 消</el-button>
        <el-button type="primary" @click="check('form')">确 定</el-button>
      </div>
    </el-dialog>
  </div>
</template>
<script>
import Parse from "parse";
import { returnLogin } from "@/utils/return";
import { getIndustry } from "@/api/applicationManagement";
export default {
  name: "Instruct",
  props: {
    productId: {
      type: String,
      default: ""
    },
    devicesId: {
      type: String,
      default: ""
    }
  },
  data() {
    var checkNumber = (rule, value, callback) => {
      if (!value) {
        return callback(new Error("超长时长不能为空"));
      }
      setTimeout(() => {
        if (!Number.isInteger(value)) {
          callback(new Error("请输入数字值"));
        } else {
          callback();
        }
      }, 1000);
    };
    var checkNumber1 = (rule, value, callback) => {
      if (!value) {
        return callback(new Error("发送间隔不能为空"));
      }
      setTimeout(() => {
        if (!Number.isInteger(value)) {
          callback(new Error("请输入数字值"));
        } else {
          callback();
        }
      }, 1000);
    };
    var checkIndex = (rule, value, callback) => {
      if (!value) {
        return callback(new Error("发送间隔不能为空"));
      }
      setTimeout(() => {
        if (!Number.isInteger(value)) {
          callback(new Error("请输入数字值"));
        } else {
          callback();
        }
      }, 1000);
    };
    var checkIndex1 = (rule, value, callback) => {
      if (!value) {
        return callback(new Error("子网编号不能为空"));
      }
 /*      setTimeout(() => {
        if (!Number.isInteger(value)) {
          callback(new Error("请输入数字值"));
        } else {
          callback();
        }
      }, 1000); */
    };
    var isValidMask = (rule, value, callback) => {
      var regx = /^(254|252|248|240|224|192|128|0)\.0\.0\.0|255\.(254|252|248|240|224|192|128|0)\.0\.0|255\.255\.(254|252|248|240|224|192|128|0)\.0|255\.255\.255\.(254|252|248|240|224|192|128|0)$/;
      if (!value) {
        return callback(new Error("子网编号不能为空"));
      } else {
        if (!regx.test(value)) {
          return callback(new Error("请输入正确的子网编号"));
        } else {
          callback();
        }
      }
    };
    return {
      formInline: {
        name: ""
      },
      options:[        
        {value:'all',label:'all'}
      ],
      instructData: [],
      multipleTable: [],
      pagesize: 10,
      start: 0,
      total: 0,
      dialogFormVisible: false,
      formLabelWidth: "120px",
      form: {
        name: "",
        pointer: "",
        type: "",
        enable: "",
        duration: "",
        order: "",
        interval: "",
        // lowerhair: "",
        rotation: "",
        subnet: ""
      },
      formrule: {
        duration: [
          { required: true, trigger: "blur" },
          { validator: checkNumber }
        ],
        interval: [
          { required: true, trigger: "blur" },
          { validator: checkNumber1 }
        ],
        name: [
          { required: true, message: "指标名称不能为空", trigger: "blur" }
        ],
        type: [{ required: true, message: "请挑选指标类型", trigger: "blur" }],
        enable: [
          { required: true, message: "指标是否启用不能为空", trigger: "change" }
        ],
        order: [
          { required: true, message: "指标序号不能为空", trigger: "blur" } //指令序号     
        ],
  /*       lowerhair: [
          { required: true, message: "下发网关不能为空", trigger: "blur" }
        ], */
        rotation: [
          { required: true, message: "生效轮次不能为空", trigger: "blur" }
        ],
        subnet: [
          { required: true, message: "子网编号不能为空", trigger: "blur" },
          { validator: checkIndex1 }
        ],
        pointer: [
          { required: true, message: "指令指标不能为空", trigger: "blur" }
        ]
      },
      instructid: "",
      dialogTitle:'新增'
    };
  },
  watch: {
    dialogFormVisible: {
      handler(val) {
        if (!val) {
            this.$refs.form.resetFields();
            console.log(val)
        }
      },
      deep: true
    },
    devicesId: {
      handler(val) {
        console.log(val)
      },
      deep: true
    }
  },
  mounted() {
      this.getInstruct()
  },
  updated() {},
  methods: {
      dialogClosed(){
         
          this.dialogFormVisible = false
      },
      openDialog(formName,type,data){
        this.$nextTick(() => {
        if(this.$refs[formName]){
            this.$refs[formName].resetFields();
        }
        switch(type){//1：查看，2：编辑，3：新增
        case '2':this.dialogTitle='编辑';this.form= data;break;
        case '3':this.dialogTitle='添加';
        break;
        default:break;
        }
    });
      },
    getInstruct(start) {
        if(start==0){
            this.start=0
        }
      var Instruct = Parse.Object.extend("Instruct");
      var instruct = new Parse.Query(Instruct);
      instruct.equalTo("device", this.devicesId);
      instruct.skip(this.start);
      instruct.limit(this.pagesize);
      if(this.formInline.name){
          instruct.matches('name',this.formInline.name,'i')
      }
      instruct.ascending('order')
      instruct.count().then(count => {
        this.total = count;
        instruct.find().then(resultes => {
          if (resultes) {
            this.instructData = resultes;
          }
        });
      });
    },
    addInstruct() {
      this.dialogFormVisible = true;
      this.$refs.form.resetFields()
    },
    check(formName) {
      this.$refs[formName].validate(valid => {
        if (valid) {
          var Instruct = Parse.Object.extend("Instruct");
          var instruct = new Instruct();
          if (this.instructid != "") {
            instruct.id = this.instructid;
          }
          var Devices = Parse.Object.extend("Device");
          var devices = new Devices();
          devices.id = this.devicesId;
          var Product = Parse.Object.extend("Product");
          var product = new Product();
          product.id = this.productId;
          instruct.set("device", devices);
          instruct.set("product", product);
          // instruct.set("instruct", this.form);
          instruct.set('name',this.form.name)
          instruct.set('enable',this.form.enable)
          instruct.set('op',this.form.type)
          instruct.set('rotation',this.form.rotation)
          instruct.set('duration',this.form.duration)
          instruct.set('order',this.form.order)
          instruct.set('interval',this.form.interval)
          instruct.set('di',this.form.pointer)
          instruct.set('pn',this.form.subnet)
          instruct.set('devaddr',this.form.lowerhair)
          instruct.save().then(resultes => {
            if (resultes) {
              this.$message({
                  type:'success',
                  message:`${this.dialogTitle}成功`
              });
               this.$refs.form.resetFields();
              this.dialogClosed()
              this.instructid = "";
              this.getInstruct()
            }
          },error=>{
              console.log(error)
          });
        } else {
          this.$message.error("有必填项未填写");
          return false;
        }
      });
    },
     handleSizeChange(val) {
        this.pagesize=val
        this.getInstruct()
      },
      handleCurrentChange(val) {
       this.start = (val-1)*this.pagesize
       this.getInstruct()
      },
    //编辑
    dialogBtn_em(formName,type,data){
        this.dialogFormVisible=true;
        //此处最好声明一个新的变量来接收数据去赋值弹框，避免影响源数据
        let opt={}
        let opt1
        if(type==2){
            opt1={
              name: data.attributes.name,
              pointer: data.attributes.di,
              type: data.attributes.op,
              enable: data.attributes.enable,
              duration: data.attributes.duration,
              order: data.attributes.order,
              interval: data.attributes.interval,
              lowerhair: data.attributes.devaddr,
              rotation: data.attributes.rotation,
              subnet: data.attributes.pn
            }
              opt = Object.assign({},opt1)
              this.instructid = data.id
        }else{
              opt = Object.assign({},data)
        }
        this.openDialog(formName,type,opt)
    },
    //单个删除指令
    deleteInstruct(id){
        
        this.$confirm('此操作将永久删除该指令, 是否继续?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
            var Instruct = Parse.Object.extend("Instruct");
            var instruct = new Instruct();
            instruct.id = id
            instruct.destroy().then(response=>{
                if(response){
                    this.$message({
                        type: 'success',
                        message: '删除成功!'
                    });
                    this.getInstruct()
                }
            },error=>{
                returnLogin(error)
            })
          
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消删除'
          });          
        });
    },
    handleSelectionChange(val){
        this.multipleTable = val
    },
    //批量删除
    deleteAll(){
      if(this.multipleTable.length==0){
           this.$message({
          message: '请挑选要删除的指令',
          type: 'warning'
        });
      }else{
          var arr=[]
          this.multipleTable.map(item=>{
              arr.push(
                  new Promise((resolve,reject)=>{
                       var Instruct = Parse.Object.extend("Instruct");
                        var instruct = new Instruct();
                        instruct.id = item.id
                        return instruct.destroy().then(resultes=>{
                            if(resultes){
                                resolve(resultes)
                            }
                        },error=>{
                            reject(error)
                        })
                  })
              )
          })
          Promise.all(arr)
                .then(data => {
                this.$message({
                    message: "删除成功",
                    type: "success"
                });
                if (data.length == this.multipleTable.length) {
                    this.getInstruct();
                }
                })
                .catch(error => {
                    this.$message({
                        message: error,
                        type: "error"
                    });
                });
      }
    }
  }
};
</script>
<style lang="scss" scoped>
.instruct {
  background: #ffffff;
  padding: 20px;
  box-sizing: border-box;
  min-height: 100%;
  .instruct_button {
    display: flex;
    flex-direction: row-reverse;
    flex-direction: unset;
    justify-content: space-between;
  }
  .instruct_table {
    margin-top: 20px;
  }
  /deep/ .el-select--small {
    width: 100%;
  }
}
</style>
